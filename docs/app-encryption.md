### Key derivation

In order to guarantee the uniqueness of keys used to encrypt and authenticate apps (`KeyAES1` and `KeyHMAC1`), 3 random *seeds* of 32 bytes are generated during the first launch of the VM app:

- `ECDHSeed`: derive the private ECDSA key (`DevPrivKey`) to wrap data sent to the HSM
- `AppEncryptionSeed`: derive the `KeyAES1` key
- `AppHMACSeed`: derive the `KeyHMAC1` key

Secrets are derived from these seeds using `SHA256(seed || app_hash)` where `app_hash` is the hash of the application.

This derivation mechanism allows the VM to derive the same set of keys for a given `app_hash`.

### App encryption

The encryption of an app is done through the following steps:

1. The host (eg. Ledger Live) asks a Ledger server for the `app_hash` of the app to be encrypted. The Ledger server returns the `app_hash` (`SHA256(name || version || code || data)`).
2. The host sends an APDU to the device to retrieve the keys derived this `app_hash`. The VM returns the following pieces of data:

  - The public key `DevPubKey` (issued from the private key `DevPrivKey`) derived from `ECDHSeed`
  - `KeyAES1` and `KeyHMAC1` wrapped using AES-256-CBC with the ECDH shared secret key computed from `DevPrivKey`

3. The host forwards these pieces of data to a Ledger HSM. The HSM:

  - Computes the ECDH shared secret key thanks to `DevPubKey`
  - Decrypts the wrapped keys `KeyAES1` and `KeyHMAC1`
  - Encrypts and authenticates the app pages using `KeyAES1` and `KeyHMAC1`
  - Signs the manifest

On the encrypted app (`app.zip`) is generated by the HSM and returned to the host, the app can be streamed to the VM as long as the VM isn't reinstalled (since it would lead to the generation of new seeds).
